version: "3.7"

services:
  # ==========================================================================
  # BASE DE DATOS MONGODB
  # ==========================================================================
  mongo-db:
    image: mongo
    container_name: mi-banco-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: "mi-banco"
    volumes:
      - mongo-data:/data/db
    networks:
      - mi-banco-network
    restart: unless-stopped
  # ==========================================================================
  # SERVIDOR BACKEND (NestJS + Fastify) - DESARROLLO CON HOT RELOAD
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    image: seventrust/mean_backend
    container_name: mi-banco-backend-dev
    ports:
      - "8001:8001"
    volumes:
      # Montar código fuente para hot reload
      - ./backend/src:/app/src
      - ./backend/test:/app/test
      - ./backend/tsconfig.json:/app/tsconfig.json
      - ./backend/tsconfig.build.json:/app/tsconfig.build.json
      - ./backend/nest-cli.json:/app/nest-cli.json
      - ./backend/.env:/app/.env
      # Volumen nombrado para node_modules (evita conflictos con host)
      - backend-node-modules:/app/node_modules
    environment:
      # Server
      PORT: 8001
      NODE_ENV: development
      ENABLE_CLUSTER: "false"
      
      # Database
      MONGODB_URI: mongodb://mongo-db:27017/mi-banco
      DB_NAME: mi-banco
      DB_CONNECTION_TIMEOUT: 10000
      DB_POOL_SIZE: 10
      
      # Security
      ALLOWED_ORIGINS: http://localhost:4200,http://localhost:3000,http://localhost:80,http://localhost
      RATE_LIMIT_MAX: 100
      RATE_LIMIT_WINDOW: "15 minutes"
      
      # Logging
      LOG_LEVEL: debug
      
      # Application
      APP_NAME: mi-banco-api
      APP_VERSION: "1.0.0"
      
      # Development
      CHOKIDAR_USEPOLLING: "true"  # Necesario para detectar cambios en Docker
    depends_on:
      - mongo-db
    networks:
      - mi-banco-network
    restart: unless-stopped
    stdin_open: true
    tty: true

  # ==========================================================================
  # CLIENTE FRONTEND - PRODUCCIÓN CON NGINX
  # ==========================================================================
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    image: seventrust/mean_frontend
    container_name: mi-banco-client
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - mi-banco-network
    restart: unless-stopped

  # ==========================================================================
  # CLIENTE FRONTEND - DESARROLLO CON HOT RELOAD (COMENTADO)
  # ==========================================================================
  # Descomentar este servicio si necesitas desarrollo con hot-reload
  # Nota: La compilación inicial puede tardar 10-15 minutos
  # client-dev:
  #   build:
  #     context: ./client
  #     dockerfile: Dockerfile.dev
  #   image: seventrust/mean_frontend_dev
  #   container_name: mi-banco-client-dev
  #   ports:
  #     - "4200:4200"
  #   volumes:
  #     - ./client:/app
  #     - client-node-modules:/app/node_modules
  #   environment:
  #     - NODE_ENV=development
  #     - NG_CLI_ANALYTICS=false
  #     - CHOKIDAR_USEPOLLING=true
  #   depends_on:
  #     - backend
  #   networks:
  #     - mi-banco-network
  #   restart: unless-stopped
  #   stdin_open: true
  #   tty: true

  # ==========================================================================
  # SERVIDOR LEGACY (Express) - DEPRECATED
  # ==========================================================================
  # Mantener comentado para referencia, será eliminado en futuras versiones
  # server:
  #   build: 
  #     context: ./server
  #     dockerfile: Dockerfile
  #   image: seventrust/mean_backend
  #   container_name: mi-banco-server
  #   ports:
  #     - "8000:8000"
  #   links:
  #     - mongo-db
  #   depends_on:
  #     - mongo-db
  #   networks:
  #     - mi-banco-network
  #   restart: unless-stopped

# ==========================================================================
# VOLÚMENES PERSISTENTES
# ==========================================================================
volumes:
  mongo-data:
    name: mi-banco-mongo-data
  client-node-modules:
    name: mi-banco-client-node-modules
  backend-node-modules:
    name: mi-banco-backend-node-modules

# ==========================================================================
# RED PERSONALIZADA
# ==========================================================================
networks:
  mi-banco-network:
    name: mi-banco-network
    driver: bridge
