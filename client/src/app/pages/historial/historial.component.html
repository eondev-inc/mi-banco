<div class="historial-page">
  <div class="container">
    <!-- Header -->
    <div class="page-header">
      <h1 class="page-header__title">Historial de Transferencias</h1>
      <p class="page-header__subtitle">Revisa todas tus transferencias realizadas</p>
    </div>

    <!-- Estado Vacío: Sin transferencias -->
    <div class="empty-state" *ngIf="!historial || historial.historial.length === 0">
      <mat-icon class="empty-state__icon">receipt_long</mat-icon>
      <h2 class="empty-state__title">No tienes transferencias realizadas</h2>
      <p class="empty-state__description">
        Cuando realices tu primera transferencia, aparecerá aquí en el historial.
      </p>
      <button
        mat-flat-button
        color="primary"
        routerLink="/transferencias"
        aria-label="Realizar primera transferencia">
        <mat-icon>payment</mat-icon>
        Realizar Primera Transferencia
      </button>
    </div>

    <!-- Tabla de Historial: Cuando hay transferencias -->
    <mat-card class="historial-card" *ngIf="historial && historial.historial.length > 0">
      <!-- Barra de búsqueda -->
      <div class="search-bar">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar transferencia</mat-label>
          <input
            matInput
            [(ngModel)]="searchText"
            (keyup)="applyFilter()"
            placeholder="Busca por nombre, banco o monto"
            aria-label="Buscar en historial">
          <mat-icon matPrefix>search</mat-icon>
          <button
            mat-icon-button
            matSuffix
            *ngIf="searchText"
            (click)="clearSearch()"
            aria-label="Limpiar búsqueda">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Contenedor de tabla con scroll horizontal en móvil -->
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="historial-table">

          <!-- Columna # -->
          <ng-container matColumnDef="index">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> # </th>
            <td mat-cell *matCellDef="let element; let i = index">
              {{ (paginator.pageIndex * paginator.pageSize) + i + 1 }}
            </td>
          </ng-container>

          <!-- Columna Nombre -->
          <ng-container matColumnDef="nombre">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Destinatario </th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="cell-icon">person</mat-icon>
                <span>{{ element.nombre }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Fecha -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha </th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="cell-icon">event</mat-icon>
                <span>{{ element.fecha | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Banco -->
          <ng-container matColumnDef="banco">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Banco </th>
            <td mat-cell *matCellDef="let element">
              <div class="cell-content">
                <mat-icon class="cell-icon">account_balance</mat-icon>
                <span>{{ element.banco }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Monto -->
          <ng-container matColumnDef="monto">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-right"> Monto </th>
            <td mat-cell *matCellDef="let element" class="monto-cell">
              <span class="monto-badge">
                {{ element.monto | currency:'CLP':'symbol-narrow':'1.0-0' }}
              </span>
            </td>
          </ng-container>

          <!-- Columna Tipo de Cuenta -->
          <ng-container matColumnDef="tipo_cuenta">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo de Cuenta </th>
            <td mat-cell *matCellDef="let element">
              <mat-chip class="tipo-cuenta-chip">
                {{ element.tipo_cuenta || 'N/A' }}
              </mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>

          <!-- Mensaje cuando no hay resultados de búsqueda -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              <div class="no-results">
                <mat-icon>search_off</mat-icon>
                <p>No se encontraron transferencias con "{{ searchText }}"</p>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Paginador -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50]"
        [pageSize]="10"
        showFirstLastButtons
        aria-label="Seleccionar página de historial">
      </mat-paginator>
    </mat-card>
  </div>
</div>
